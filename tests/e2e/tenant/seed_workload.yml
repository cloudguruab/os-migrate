- name: Create osm_volume
  os_volume:
    display_name: osm_volume
    size: 1
    auth: "{{ os_migrate_src_auth }}"
    validate_certs: "{{ os_migrate_src_validate_certs|default(omit) }}"
    ca_cert: "{{ os_migrate_src_ca_cert|default(omit) }}"
    client_cert: "{{ os_migrate_src_client_cert|default(omit) }}"
    client_key: "{{ os_migrate_src_client_key|default(omit) }}"

- name: Create osm_server
  os_server:
    name: osm_server
    state: present
    flavor: "{{ os_migrate_src_osm_server_flavor|default(m1.small) }}"
    key_name: osm_key
    image: "{{ workload_image }}"
    network: osm_net
    security_groups: osm_security_group
    volumes:
      - osm_volume
    # We get a floating IP
    # for the workload VM
    auto_ip: yes
    # Wait for the instance to be created
    wait: yes
    auth: "{{ os_migrate_src_auth }}"
    validate_certs: "{{ os_migrate_src_validate_certs|default(omit) }}"
    ca_cert: "{{ os_migrate_src_ca_cert|default(omit) }}"
    client_cert: "{{ os_migrate_src_client_cert|default(omit) }}"
    client_key: "{{ os_migrate_src_client_key|default(omit) }}"

# In order to be able to migrate the VMS they must be turned off
- name: Shutdown osm_server
  os_server_action:
    auth: "{{ os_migrate_src_auth }}"
    server: osm_server
    action: stop
    wait: yes
    validate_certs: "{{ os_migrate_src_validate_certs|default(omit) }}"
    ca_cert: "{{ os_migrate_src_ca_cert|default(omit) }}"
    client_cert: "{{ os_migrate_src_client_cert|default(omit) }}"
    client_key: "{{ os_migrate_src_client_key|default(omit) }}"
